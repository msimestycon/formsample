# Changelog

All notable changes to the Bizuit Custom Forms project will be documented in this file.

## [1.1.2] - 2025-11-13

### Fixed - Critical Build Issues

#### Problem 1: Dynamic require of 'react' is not supported
**Root Cause**: esbuild was generating fallback code with `typeof require` pattern even when marking React as external.

**Solution**: Created `globalReactPlugin` for esbuild that intercepts React/ReactDOM imports at build time and replaces them with `window.React`/`window.ReactDOM` references.

```javascript
const globalReactPlugin = {
  name: 'global-react',
  setup(build) {
    // Intercept react imports
    build.onResolve({ filter: /^react$/ }, args => {
      return { path: args.path, namespace: 'global-react' }
    })

    // Replace with window.React
    build.onLoad({ filter: /.*/, namespace: 'global-react' }, args => {
      const contents = args.path === 'react'
        ? 'module.exports = window.React'
        : 'module.exports = window.ReactDOM'
      return { contents, loader: 'js' }
    })
  }
}
```

#### Problem 2: Form does not export a default component
**Root Cause**: esbuild format `iife` was generating a global variable instead of ES6 module with proper exports.

**Solution**: Changed build format from `iife` to `esm` to generate proper ES6 modules with `export default`.

**Before** (IIFE):
```javascript
var BizuitForm_solicitud_vacaciones = (function() { ... })();
```

**After** (ESM):
```javascript
function FormComponent() { ... }
export { FormComponent as default };
```

#### Problem 3: GitHub Actions double-zipping artifacts
**Root Cause**: Workflow was manually creating .zip then uploading to artifacts, causing GitHub Actions to wrap it in another .zip.

**Solution**: Upload `deployment-package/` directory directly instead of pre-zipped file. GitHub Actions automatically zips the artifact.

### Changed
- **build-form.js**:
  - Added `globalReactPlugin` to intercept React imports
  - Changed format from `iife` to `esm`
  - Removed `globalName` (not needed for ESM)
- **.gitignore**: Added `deployment-package/` (generated by CI only)
- **.github/workflows/build-deployment-package.yml**:
  - Upload directory instead of .zip file
  - Prevent double-zipping

### Technical Details

**Plugin Implementation**:
- Intercepts: `react`, `react-dom`, `react/jsx-runtime`, `react/jsx-dev-runtime`
- Returns: `window.React`, `window.ReactDOM`, `window.React.createElement` references
- Result: No `require()` fallback code generated

**Module Format**:
- Old: IIFE with global variable
- New: ES6 module with `export default`
- Compatible with: Dynamic `import()` in form-loader

**Verification**:
```bash
# Check for typeof require (should not be found)
grep -i "typeof require" dist/form.js

# Check for export default (should be found)
tail -n 5 dist/form.js  # Should see: export{X as default};
```

## [1.0.0] - 2025-11-13

### Added - New Form: Solicitud de Soporte TÃ©cnico

**Description**: IT Support ticket creation form with categories, priorities, and rich details.

**Features**:
- **Categories**: Software, Hardware, Network, Access, Other (with icons)
- **Priorities**: Low, Medium, High, Critical (with color coding)
- **Fields**:
  - Subject (required)
  - Problem description (required, with character counter)
  - Category selector (required)
  - Priority selector (required)
  - Location/Area (optional)
  - Contact phone (optional)
  - Affected equipment (optional)
- **Visual feedback**: Dynamic priority/category preview with colors
- **Responsive design**: Grid layout for desktop/mobile

**Technical Specs**:
- Package: `@tyconsa/bizuit-form-solicitud-soporte`
- Version: 1.0.0
- Compiled size: 8.08 KB
- Format: ESM with `export default`
- No `typeof require` issues

**Color Coding by Priority**:
- ğŸŸ¢ Baja: Green background
- ğŸŸ¡ Media: Yellow background
- ğŸŸ  Alta: Orange background
- ğŸ”´ CrÃ­tica: Red background

### Infrastructure

**Database Integration**:
- FastAPI backend endpoints for forms list and compiled code
- SQL Server integration via `database.py`
- Next.js API proxy routes

**Deployment Pipeline**:
- GitHub Actions workflow for automated compilation
- 90-day artifact retention
- Manifest generation with form metadata

## Project Structure

```
bizuit-custom-form-sample/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ build-deployment-package.yml
â”œâ”€â”€ solicitud-vacaciones/         # Vacation request form (v1.1.2)
â”‚   â”œâ”€â”€ src/index.tsx
â”‚   â”œâ”€â”€ dist/form.js
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ solicitud-soporte/            # IT support form (v1.0.0) â­ NEW
â”‚   â”œâ”€â”€ src/index.tsx
â”‚   â”œâ”€â”€ dist/form.js
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ aprobacion-gastos/            # Expense approval form
â”‚   â”œâ”€â”€ src/index.tsx
â”‚   â”œâ”€â”€ dist/form.js
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ build-form.js                 # Universal build script
â””â”€â”€ README.md
```

## Commits

- `fa58f3a` - fix: change esbuild format from iife to esm
- `53f1fb2` - chore: remove deployment-package from git
- `bf86236` - fix: use esbuild plugin to properly replace React imports
- `d6121f2` - feat: add new solicitud-soporte form

## Testing

### Local Testing
```bash
# Build form
cd solicitud-soporte
npm run build

# Verify no typeof require
grep -i "typeof require" dist/form.js  # Should return nothing

# Verify export default
tail -n 1 dist/form.js  # Should show: export{X as default};
```

### Runtime Testing
1. Download deployment package from GitHub Actions artifacts
2. Upload via admin: http://localhost:3001/admin/upload-forms
3. Test forms:
   - http://localhost:3001/form/solicitud-vacaciones
   - http://localhost:3001/form/solicitud-soporte

## Known Issues

None at this time. All critical issues resolved.

## Future Enhancements

- [ ] Add file attachment support for forms
- [ ] Implement form validation library (e.g., Zod)
- [ ] Add more form templates
- [ ] Hot reload optimization
- [ ] Form versioning in UI
